{% extends 'project/base.html' %}
{% load getattr %}
{% load render_table from django_tables2 %}
{% block extra_js_up %}
    <script>
        var recalc_url = "{% url 'plant_profile_precalc' instance.pk  %}";
    </script>
{% endblock %}
{% block content %}
    <div class="container">
    <h1 class="text-center">{{ title }}</h1>

        <div class="row">
            {% if form.errors %}
                {{ form.errors }}
            {% endif %}
        </div>
        <div class="row">
            <form action="{% url "plant_profile_edit" instance.pk %}" method="post"
                  class="  m-auto d-flex justify-content-between"
                  id="form-{{ instance.pk }}">
                <input type="hidden" name="pk" id="pk" value="{{ instance.pk }}">

                <div class="row">
                    {% csrf_token %}

                    <div class="row">
                        <div class="mb-3  col-3 p-1">
                            <label for="{{ form.name.label.id_for_label }}"
                                   class="form-label">{{ form.name.label }}</label>
                            {{ form.name }}
                            <div class="error">{{ form.name.errors }}</div>
                        </div>
                        {% if micro == False %}
                        <div class="mb-3  col-3 p-1">
                            <label for="{{ form.calc_mode.label.id_for_label }}"
                                   class="form-label">{{ form.calc_mode.label }}</label>
                            {{ form.calc_mode }}
                            <div class="error">{{ form.calc_mode.errors }}</div>
                        </div>
                        {% else %}
                              <div class="mb-3  col-3 p-1">
                                    <label for="{{ form.micro_calc_mode.label.id_for_label }}"
                                           class="form-label">{{ form.micro_calc_mode.label }}</label>
                                    {{ form.micro_calc_mode }}
                                    <div class="error">{{ form.micro_calc_mode.errors }}</div>
                                </div>
                        {% endif %}



                          <div class="mb-3  col-1 p-1">
                            <label for="{{ form.litres.label.id_for_label }}"
                                   class="form-label">{{ form.litres.label }}</label>
                            {{ form.litres }}
                            <div class="error">{{ form.litres.errors }}</div>
                        </div>
                        <div class="mb-3  col-2 p-1">
                            <label for="">Солей в граммах:</label>
                            <label  id="id_salt_grams" class="form-label precalc"> {{ instance.sum_salt_grams|hpg_float_format }}</label>
                        </div>



                    </div>

                <div class="row">
                    <p class="npk-bold precalc" id="id_npk_formula">{{ instance.calc_npk_formula }}</p>
                    <p class="npk-bold precalc" id="id_npk_magazine">{{ instance.get_npk_magazine }}</p>


                </div>
                {% if not micro %}

                    <div class="row">


                     <div class="row">
                        <h5 class=" ">Макропрофиль в мг/л (ppm)</h5>
                    </div>
                        <div class="row row-cols-auto first-macro-row">
                        <div class="col-1"></div>
                            {% for f in form %}

                                {% if f.name in instance.macro  and   f.name != 'no3' and f.name != 'nh4' %}


                                    <div class="mb-3 col-1 p-1  macro-salt text-center">
                                        <label for="{{ f.id_for_label }}" class="form-label">{{ f.label }}</label>
                                        {{ f }}
                                        <div class="error">{{ f.errors }}</div>
                                    </div>


                                    {% endif %}


                            {% endfor %}

                              <div class="mb-3  col-1 p-1">
                            <label    class="form-label">ЕС</label>


                          <input type="number" name="ec"  value="{{ instance.calc_ec|hpg_float_format  }}"  step="0.01"
                                 class="form-control d-inline-block precalc hpg-green" required=""
                                               id="id_ec">

                        </div>
                        </div>

                        <div class="row row-cols-auto height-30">
                            {% for f in form %}
                                {% if   f.name == 'no3'  %}
                                    <div class="mb-3 col-1 p-1  macro-salt text-center">
                                        <label for="{{ f.id_for_label }}" class="form-label">{{ f.label }}</label>
                                    </div>
                                    <div class="mb-3 col-1 p-1  macro-salt text-center">
                                        {{ f }}
                                        <div class="error">{{ f.errors }}</div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                     <div class="row row-cols-auto height-30">
                            {% for f in form %}
                                {% if   f.name == 'nh4'  %}
                                    <div class="mb-3 col-1 p-1  macro-salt text-center">
                                        <label for="{{ f.id_for_label }}" class="form-label">{{ f.label }}</label>
                                    </div>
                                    <div class="mb-3 col-1 p-1  macro-salt text-center">
                                        {{ f }}
                                        <div class="error">{{ f.errors }}</div>
                                    </div>
                                {% endif %}
                            {% endfor %}


                          <div class="mb-3 col-1 p-1  macro-salt text-center">
                                <input type="number" name="nh4_nh3_ratio"  value="{{ instance.nh4_nh3_ratio|hpg_float_format  }}"  step="0.01"
                                     class="form-control d-inline-block precalc hpg-green" required="" id="id_nh4_nh3_ratio">


                                <div class="error">{{ form.nh4_nh3_ratio.errors }}</div>
                            </div>
                       <div class="mb-3 col-2 p-1  macro-salt text-center">

                            <label for="{{ form.nh4_nh3_ratio.label.id_for_label }}"
                                   id="id_name-nh4_nh3_ratio"
                                   class="form-label">{{ form.nh4_nh3_ratio.label }}</label>
                           </div>



                    </div>


                    <div class="row">
                        <h5 class=" ">Соотношения элементов</h5>
                    </div>
                    <div class="row matrix">
                        <div class="row">
                        <div class="col-1"></div>
                            {% for i in instance.macro_matrix %}
                                <div class="col-1 text-center"> {{ i|title }}</div>

                            {% endfor %}
                        </div>
                        {% for row in  instance.get_matrix %}
                            <div class="row salt-row {% if forloop.first %}first-matrix-row{% else %}second-matrix-row{% endif %}">
                                {% for elem, val in row.items %}
                            {% if forloop.first %}
                                <div class="text-center col-1">
                                    <label for="id_matrix-{{ elem }}-{{ instance.macro_matrix|index:forloop.parentloop.counter0  }}"
                                           class=" form-label d-block p-1 ">
                                        {{ instance.macro_matrix|index:forloop.parentloop.counter0|title }}
                                    </label>
                                </div>
                            {% endif %}
                                    <div class="mb-1 text-center col-1 p-1">

                                        {% with instance.macro_matrix|index:forloop.parentloop.counter0  as parent_elem %}
                                        <input type="number"
                                               name="matrix-{{ elem }}-{{ parent_elem }}"
                                               id="id_matrix-{{ elem }}-{{ parent_elem  }}"
                                               value="{{ val|hpg_float_format }}"
                                               step="0.01"
                                               class="form-control d-inline-block precalc matrix {% if elem == 'k' %} {% if parent_elem == 'n' or parent_elem == 'mg' or parent_elem == 'ca' %}hpg-green{% endif %}{% endif %}"
                                               {% if forloop.parentloop.counter == forloop.counter   %}disabled{% endif %}
                                               required="" id="id_matrix-{{ elem }}-
                                                {{ parent_elem }}">
                                        {% endwith %}
                                    </div>

                                {% endfor %}
                            </div>

                        {% endfor %}

                    </div>


                    <div class="row">
                        <h5>Соли</h5>
                    </div>
                    <div class="row salts">

                        {% for comon, salt_data in instance.get_salt_dict.items %}
                              <div class="row salt-row">
                                <div class="col-4  d-sm-flex pt-2 justify-content-start salt_name w-salt-name">
                                    <span id="id_name-{{ comon }}"class="salt-name-formula">{{ salt_data.name }} {{ salt_data.formula }}</span>
                                    <span class="  salt-formula">{{ salt_data.formula }}</span>
                                </div>
                                {% for salt in salt_data.salt %}
                                    {% with form|get_field_from_form:salt as f %}
                                        <div class="mb-1 salt-percent {% if f.name == 'name' %}col-12{% else %}col-2{% endif %}
                                              p-1 d-flex align-items-center justify-content-between">

                                            <div class="col-1 ">
                                                <label for="{{ f.id_for_label }}"  class="form-label mb-0">{{ f.label|second_part }}</label>
                                            </div>
                                            {{ f }}
                                            <div class="error">{{ f.errors }}</div>
                                        </div>
                                    {% endwith %}
                                {% endfor %}
                                {% if salt_data.salt|length == 2 %}
                                    <div class="mb-1 d-none  d-sm-flex text-center col-2 p-1"></div>
                                {% endif %}
                                <div class="mb-1 text-center col-1 p-1 d-flex align-items-center justify-content-between">

                                    <input type="number"  name="{{ comon }}"
                                           value="{{ instance|getattribute:comon|hpg_float_format }}"
                                           step="0.01" class="form-control d-inline-block precalc" required=""
                                           {% if comon == 'kno3' and instance.calc_mode == 'Mg' %}disabled{% endif %}
                                           {% if comon == 'mgno3' and instance.calc_mode == 'K' %}disabled{% endif %}
                                           id="id_{{ comon }}">
                                </div>
                            </div>

                        {% endfor %}


                    </div>


                </div>

                    {% else %}
                     <div class="row">


                     <div class="row">
                        <h5 class=" ">Микропрофиль в <span class="text-danger">мкг/л</span> (ppm)</h5>
                    </div>
                        <div class="row row-cols-auto first-macro-row">
                        <div class="col-1"></div>
                            {% for f in form %}

                                {% if f.name in instance.micro    %}


                                    <div class="mb-3 col-1 p-1  macro-salt text-center">
                                        <label for="{{ f.id_for_label }}" class="form-label">{{ f.label }}</label>
                                        {{ f }}
                                        <div class="error">{{ f.errors }}</div>
                                    </div>


                                    {% endif %}


                            {% endfor %}


                        </div>

                    <div class="row">
                        <h5>Составы солей</h5>
                    </div>

                    <div class="row salts">


                    <div class="row">
                        <div class="col-2"></div>
                        <div class="col-1">
                            <label for="">доля (%)</label>
                        </div>
                        <div class="col-1 ps-0 text-left">
                            <label for="">граммы</label>
                        </div>
                    </div>
                        {% for salt, salt_data in instance.salt_micro_dict.items %}
                              <div class="row salt-row">
                                <div class="col-2 d-sm-flex pt-2 justify-content-start salt_name w-salt-name">
                                    <span id="id_name-{{ salt_data.name }}"class="salt-name-formula">{{ salt_data.name }} </span>
                                    <span class="  salt-formula">{{ salt_data.name}}</span>
                                </div>
                                <div class="mb-1 text-center col-6 p-1 d-flex align-items-center justify-content-start">

                                    <input type="number"  name="d{{ salt }}"
                                           value="{{ instance|getattribute:salt_data.d|hpg_float_format }}"
                                           step="1" class="form-control d-inline-block  w-115 precalc" required=""
                                           id="id_d{{ salt }}">
                                     <input type="number"  name="g{{ salt }}"
                                           value="{{ instance|getattribute:salt_data.g|floatformat:5 }}"
                                           step="0.001" class="form-control w-115 d-inline-block precalc" required=""
                                           id="id_g{{ salt }}">
                                </div>
                            </div>

                        {% endfor %}


                    </div>


                </div>



                {% endif %}



            </form>
            <div class="row">
                         <div class="row mt-3">
                             <p>Всего необходимо добавить на
                                 <input type="number"  name="v_micro"
                                           value="{{  instance.v_micro|floatformat:0 }}"
                                           step="100" class="form-control w-115 d-inline-block precalc" required=""
                                           id="id_v_micro"> <span class="text-danger">мл</span>

                                    <input type="number"  name="weight_micro"
                                           value="{{  instance.weight_micro|floatformat:5 }}"
                                           step="0.001" class="form-control w-115 d-inline-block precalc" required=""
                                           id="id_weight_micro"> грамм


                             </p>

                        </div>

                         <div class="row">
                            <p id="id_micro_text">{{ instance.micro_text }} </p>
                            <p id="id_micro_sostav">{{ instance.micro_sostav }}</p>
                        </div>


                    </div>

            <div class="row mt-5 mb-5">
                <div class="col-6 m-auto">
                    <button class="btn btn-primary d-block m-auto" type="submit"
                            form="form-{{ instance.pk }}">{{ btn_name }}</button>
                </div>
            </div>



        </div>


    </div>
    <style>
    @media screen and (max-width: 768px)  {

	   html{
			  width: 768px;
			  overflow: auto;
		  }
}

    </style>
{% endblock %}
